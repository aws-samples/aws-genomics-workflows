



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-3.1.0">
    
    
      
        <title>Overview - Genomics Workflows on AWS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.11e41852.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../assets/javascripts/modernizr.20ef595d.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#nextflow-on-aws-batch" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../index.html" title="Genomics Workflows on AWS" class="md-header-nav__button md-logo">
          
            <img src="../../images/AWS_logo_RGB_REV.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Genomics Workflows on AWS
              </span>
              <span class="md-header-nav__topic">
                Overview
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/aws-samples/aws-genomics-workflows/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Contribute
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../index.html" title="Genomics Workflows on AWS" class="md-nav__button md-logo">
      
        <img src="../../images/AWS_logo_RGB_REV.svg" width="48" height="48">
      
    </a>
    Genomics Workflows on AWS
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/aws-samples/aws-genomics-workflows/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Contribute
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../index.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../disclaimer.html" title="Disclaimer" class="md-nav__link">
      Disclaimer
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../quick-start.html" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Core Environment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Core Environment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/introduction.html" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/create-s3-bucket.html" title="Data Storage" class="md-nav__link">
      Data Storage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/create-iam-roles.html" title="Permissions" class="md-nav__link">
      Permissions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/create-custom-compute-resources.html" title="Compute Resources" class="md-nav__link">
      Compute Resources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/setup-aws-batch.html" title="AWS Batch" class="md-nav__link">
      AWS Batch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/custom-deploy.html" title="Customized Deployment" class="md-nav__link">
      Customized Deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/build-custom-distribution.html" title="Building a Custom Distribution" class="md-nav__link">
      Building a Custom Distribution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Workflow Orchestration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Workflow Orchestration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../orchestration-intro.html" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2">
    
    <label class="md-nav__link" for="nav-5-2">
      AWS Step Functions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        AWS Step Functions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../step-functions/step-functions-overview.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Cromwell
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Cromwell
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cromwell/cromwell-overview.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cromwell/cromwell-examples.html" title="Examples" class="md-nav__link">
      Examples
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cromwell/cromwell-trouble-shooting.html" title="Trouble Shooting" class="md-nav__link">
      Trouble Shooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4" checked>
    
    <label class="md-nav__link" for="nav-5-4">
      Nextflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Nextflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Overview
      </label>
    
    <a href="nextflow-overview.html" title="Overview" class="md-nav__link md-nav__link--active">
      Overview
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" title="Requirements" class="md-nav__link">
    Requirements
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc" title="VPC" class="md-nav__link">
    VPC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genomics-workflow-core" title="Genomics Workflow Core" class="md-nav__link">
    Genomics Workflow Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-resources" title="Nextflow Resources" class="md-nav__link">
    Nextflow Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-details" title="Deployment Details" class="md-nav__link">
    Deployment Details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nextflow-container" title="Nextflow container" class="md-nav__link">
    Nextflow container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#job-instance-aws-cli" title="Job instance AWS CLI" class="md-nav__link">
    Job instance AWS CLI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-job-definition" title="Batch job definition" class="md-nav__link">
    Batch job definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-iam-role" title="Nextflow IAM Role" class="md-nav__link">
    Nextflow IAM Role
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nextflow-batch-access" title="Nextflow-Batch-Access" class="md-nav__link">
    Nextflow-Batch-Access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-s3bucket-access" title="Nextflow-S3Bucket-Access" class="md-nav__link">
    Nextflow-S3Bucket-Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-specific-s3-bucket" title="Nextflow specific S3 Bucket" class="md-nav__link">
    Nextflow specific S3 Bucket
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-process-definitions" title="Workflow process definitions" class="md-nav__link">
    Workflow process definitions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-workflows" title="Running workflows" class="md-nav__link">
    Running workflows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-optimizing-workflows" title="Cost optimizing workflows" class="md-nav__link">
    Cost optimizing workflows
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="nextflow-trouble-shooting.html" title="Trouble Shooting" class="md-nav__link">
      Trouble Shooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cost-effective-workflows/cost-effective-workflows.html" title="Cost Effective Workflows" class="md-nav__link">
      Cost Effective Workflows
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" title="Requirements" class="md-nav__link">
    Requirements
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc" title="VPC" class="md-nav__link">
    VPC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genomics-workflow-core" title="Genomics Workflow Core" class="md-nav__link">
    Genomics Workflow Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-resources" title="Nextflow Resources" class="md-nav__link">
    Nextflow Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-details" title="Deployment Details" class="md-nav__link">
    Deployment Details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nextflow-container" title="Nextflow container" class="md-nav__link">
    Nextflow container
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#job-instance-aws-cli" title="Job instance AWS CLI" class="md-nav__link">
    Job instance AWS CLI
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-job-definition" title="Batch job definition" class="md-nav__link">
    Batch job definition
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-iam-role" title="Nextflow IAM Role" class="md-nav__link">
    Nextflow IAM Role
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nextflow-batch-access" title="Nextflow-Batch-Access" class="md-nav__link">
    Nextflow-Batch-Access
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-s3bucket-access" title="Nextflow-S3Bucket-Access" class="md-nav__link">
    Nextflow-S3Bucket-Access
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nextflow-specific-s3-bucket" title="Nextflow specific S3 Bucket" class="md-nav__link">
    Nextflow specific S3 Bucket
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow-process-definitions" title="Workflow process definitions" class="md-nav__link">
    Workflow process definitions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-workflows" title="Running workflows" class="md-nav__link">
    Running workflows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-optimizing-workflows" title="Cost optimizing workflows" class="md-nav__link">
    Cost optimizing workflows
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-genomics-workflows/edit/master/docs/orchestration/nextflow/nextflow-overview.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="nextflow-on-aws-batch">Nextflow on AWS Batch</h1>
<p><img alt="Nextflow on AWS" src="images/nextflow-on-aws-infrastructure.png" /></p>
<p><a href="https://www.nextflow.io">Nextflow</a> is a reactive workflow framework and domain specific language (DSL) developed by the <a href="https://www.crg.eu/en/programmes-groups/notredame-lab">Comparative Bioinformatics group</a> at the Barcelona <a href="http://www.crg.eu/">Centre for Genomic Regulation (CRG)</a> that enables scalable and reproducible scientific workflows using software containers.</p>
<p>Nextflow can be run either locally or on a dedicated EC2 instance.  The latter is preferred if you have long running workflows - with the caveat that you are responsible for stopping the instance when your workflow is complete.  The architecture presented in this guide demonstrates how you can run Nextflow using AWS Batch in a managed and cost effective fashion.</p>
<h2 id="requirements">Requirements</h2>
<p>To get started using Nextflow on AWS you'll need the following setup in your AWS account:</p>
<ul>
<li>A VPC with at least 2 subnets (preferrably ones that are <strong>private</strong>)</li>
<li>The Genomics Workflow <a href="../../core-env/introduction.html">Core Environment</a></li>
<li>A containerized <code>nextflow</code> executable with a custom entrypoint script that uses AWS Batch supplied environment variables for configuration information</li>
<li>A Batch Job Definition that runs a Nextflow head node</li>
<li>An IAM Role for the Nextflow head node job that allows it to submit AWS Batch jobs</li>
<li>(optional) An S3 Bucket to store your Nextflow session cache</li>
</ul>
<p>The following will help you deploy these components</p>
<h3 id="vpc">VPC</h3>
<p>If you are handling sensitive data in your Nextflow pipelines, we recommend using at least 2 <strong>private</strong> subnets for AWS Batch compute jobs. EC2 instances launched into <strong>private</strong> subnets do not have public IP addresses, and therefore cannot be directly accessed from the public internet. They can still retain internet access from within the VPC - e.g. to pull source code, retrive public datasets, or install required softwre - if networking is configured appropriately. If the target VPC you want to deploy Nextflow into already has this, you can skip ahead. If not, you can use the CloudFormation template below, which uses the <a href="https://aws.amazon.com/quickstart/architecture/vpc/">AWS VPC Quickstart</a>, to create one meeting these requirements.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th style="text-align: center;">Source</th>
<th style="text-align: center;">Launch Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td>VPC (Optional)</td>
<td>Creates a new Virtual Private Cloud to use for your genomics workflow resources.</td>
<td style="text-align: center;"><a href="https://aws-quickstart.s3.amazonaws.com/quickstart-aws-vpc/templates/aws-vpc.template.yaml" target="_blank"><i class="material-icons">cloud_download</i></a></td>
<td style="text-align: center;"><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=GenomicsVPC&templateURL=https://aws-quickstart.s3.amazonaws.com/quickstart-aws-vpc/templates/aws-vpc.template.yaml" target="_blank" class="launch-button"><i class="material-icons">play_arrow</i></a></td>
</tr>
</tbody>
</table>
<h3 id="genomics-workflow-core">Genomics Workflow Core</h3>
<p>To launch the Genomics Workflow Core in your AWS account, use the CloudFormation template below.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th style="text-align: center;">Source</th>
<th style="text-align: center;">Launch Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td>Genomics Workflow Core</td>
<td>Create EC2 Launch Templates, AWS Batch Job Queues and Compute Environments, a secure Amazon S3 bucket, and IAM policies and roles within an <strong>existing</strong> VPC. <em>NOTE: You must provide VPC ID, and subnet IDs</em>.</td>
<td style="text-align: center;"><a href="https://github.com/aws-samples/aws-genomics-workflows/blob/master/src/templates/gwfcore/gwfcore-root.template.yaml" target="_blank"><i class="material-icons">cloud_download</i></a></td>
<td style="text-align: center;"><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=gwfcore&templateURL=https://aws-genomics-workflows.s3.amazonaws.com/latest/templates/gwfcore/gwfcore-root.template.yaml" target="_blank" class="launch-button"><i class="material-icons">play_arrow</i></a></td>
</tr>
</tbody>
</table>
<p>The core is agnostic of the workflow orchestrator you intended to use, and can be installed multiple times in your account if needed (e.g. for use by different projects). Each installation uses a <code>Namespace</code> value to group resources accordingly. By default, the <code>Namespace</code> is set to the stack name, which must be unique within an AWS region.</p>
<p>See the <a href="../../core-env/introduction.html">Core Environment</a> For more details on the core's architecture.</p>
<h3 id="nextflow-resources">Nextflow Resources</h3>
<p>The the following CloudFormation template will create a <code>nextflow</code> container image, Batch Job Definition, and an IAM Role for a Nextflow head node job:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th style="text-align: center;">Source</th>
<th>Launch Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td>Nextflow Resources</td>
<td>Create Nextflow specific resources needed to run on AWS: an S3 Bucket for nextflow workflow scripts, Nextflow container, AWS Batch Job Definition for a Nextflow head node, and an IAM role for the nextflow head node job</td>
<td style="text-align: center;"><a href="https://github.com/aws-samples/aws-genomics-workflows/blob/master/src/templates/nextflow/nextflow-resources.template.yaml" target="_blank"><i class="material-icons">cloud_download</i></a></td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=nextflow-resources&templateURL=https://aws-genomics-workflows.s3.amazonaws.com/latest/templates/nextflow/nextflow-resources.template.yaml" target="_blank" class="launch-button"><i class="material-icons">play_arrow</i></a></td>
</tr>
</tbody>
</table>
<h2 id="deployment-details">Deployment Details</h2>
<h3 id="nextflow-container">Nextflow container</h3>
<p>For AWS Batch to run Nextflow as a Batch Job, it needs to be containerized.  The container image for <code>nextflow</code> built by the Nextflow Resources CloudFormation template includes capabilities to automatically configure Nextflow and run workflow scripts in S3.  If you want to add specialized capabilities or require a particular version of Nextflow, you can modify the source code to best suit your needs.</p>
<p>To create such a container, you can use a <code>Dockerfile</code> like the one below:</p>
<pre><code class="language-Dockerfile"># use the upstream nextflow container as a base image
ARG VERSION=latest
FROM nextflow/nextflow:${VERSION} AS build

FROM amazonlinux:2 AS final
COPY --from=build /usr/local/bin/nextflow /usr/bin/nextflow

RUN yum update -y \
 &amp;&amp; yum install -y \
    curl \
    hostname \
    java \
    unzip \
 &amp;&amp; yum clean -y all
RUN rm -rf /var/cache/yum

# install awscli v2
RUN curl -s &quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot; -o &quot;/tmp/awscliv2.zip&quot; \
 &amp;&amp; unzip -q /tmp/awscliv2.zip -d /tmp \
 &amp;&amp; /tmp/aws/install -b /usr/bin \
 &amp;&amp; rm -rf /tmp/aws*

ENV JAVA_HOME /usr/lib/jvm/jre-openjdk/

# invoke nextflow once to download dependencies
RUN nextflow -version

# install a custom entrypoint script that handles being run within an AWS Batch Job
COPY nextflow.aws.sh /opt/bin/nextflow.aws.sh
RUN chmod +x /opt/bin/nextflow.aws.sh

WORKDIR /opt/work
ENTRYPOINT [&quot;/opt/bin/nextflow.aws.sh&quot;]
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are trying to keep your container image as small as possible, keep in mind that Nextflow relies on basic linux tools such as <code>awk</code>, <code>bash</code>, <code>ps</code>, <code>date</code>, <code>sed</code>, <code>grep</code>, <code>egrep</code>, and <code>tail</code> which may need to be installed on extra minimalist base images like <code>alpine</code>.</p>
</div>
<p>An example entrypoint script for the container is shown below and demonstrates how to wrap a <code>nextflow run ...</code> command so that it can be run as an AWS Batch Job. The script takes command line arguments that are passed in by AWS Batch during job submission. The first parameter should be a Nextflow "project", and any additional parameters are passed along to the Nextflow executable. Nextflow supports pulling projects directly from Git repositories. You can extend this behavior to allow projects to be specified as an S3 URI - a bucket and folder therein where you have staged your Nextflow scripts and supporting files (like additional config files). This is useful if you publish tested pipelines (e.g. via a continuous integration workflow) as static artifacts in S3. For details on how to do this see the <a href="https://github.com/aws-samples/aws-genomics-workflows/blob/master/src/containers/nextflow/nextflow.aws.sh">full source code for the script</a>.</p>
<p>The script automatically configures Nextflow to use AWS Batch using environment variables defined in the Nextflow Job Definition. These include:</p>
<ul>
<li><code>NF_WORKDIR</code> - an S3 URI used for to store intermediate and final workflow outputs</li>
<li><code>NF_LOGSDIR</code> - an S3 URI used to store workflow session cache and logs</li>
<li><code>NF_JOB_QUEUE</code> - the AWS Batch Job Queue that workflow processes will be submitted to</li>
</ul>
<p>Importantly, the script also handles restoration/preservation of the workflow session cache to enable using previously computed results via the <code>-resume</code> flag.</p>
<pre><code class="language-bash">#!/bin/bash

NEXTFLOW_PROJECT=$1  # first argument is a project
shift
NEXTFLOW_PARAMS=&quot;$@&quot;  # additional arguments are nextflow options (e.g. -resume) or workflow parameters

# Create the default config using environment variables
# passed into the container by AWS Batch
NF_CONFIG=~/.nextflow/config

cat &lt;&lt; EOF &gt; $NF_CONFIG
workDir = &quot;$NF_WORKDIR&quot;
process.executor = &quot;awsbatch&quot;
process.queue = &quot;$NF_JOB_QUEUE&quot;
aws.batch.cliPath = &quot;/home/ec2-user/miniconda/bin/aws&quot;
EOF

echo &quot;=== CONFIGURATION ===&quot;
cat ~/.nextflow/config

# stage in session cache
# .nextflow directory holds all session information for the current and past runs.
# it should be `sync`'d with an s3 uri, so that runs from previous sessions can be 
# resumed
echo &quot;== Restoring Session Cache ==&quot;
aws s3 sync --only-show-errors $NF_LOGSDIR/.nextflow .nextflow

function preserve_session() {
    # stage out session cache
    if [ -d .nextflow ]; then
        echo &quot;== Preserving Session Cache ==&quot;
        aws s3 sync --only-show-errors .nextflow $NF_LOGSDIR/.nextflow
    fi

    # .nextflow.log file has more detailed logging from the workflow session and is
    # nominally unique per session.
    #
    # when run locally, .nextflow.logs are automatically rotated
    # when syncing to S3 uniquely identify logs by the AWS Batch Job ID
    if [ -f .nextflow.log ]; then
        echo &quot;== Preserving Session Log ==&quot;
        aws s3 cp --only-show-errors .nextflow.log $NF_LOGSDIR/.nextflow.log.$AWS_BATCH_JOB_ID
    fi
}

# set a trap so that session information is preserved when the container exits
trap preserve_session EXIT

echo &quot;== Running Workflow ==&quot;
echo &quot;nextflow run $NEXTFLOW_PROJECT $NEXTFLOW_PARAMS&quot;
nextflow run $NEXTFLOW_PROJECT $NEXTFLOW_PARAMS
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code>AWS_BATCH_JOB_ID</code> is one of several <a href="https://docs.aws.amazon.com/batch/latest/userguide/job_env_vars.html">environment variables that are automatically provided</a> to all AWS Batch jobs.  The <code>NF_WORKDIR</code>, <code>NF_LOGSDIR</code>, and <code>NF_JOB_QUEUE</code> variables are ones set by the Batch Job Definition (<a href="#batch-job-definition">see below</a>).</p>
</div>
<h3 id="job-instance-aws-cli">Job instance AWS CLI</h3>
<p>Nextflow uses the <a href="https://aws.amazon.com/cli/">AWS CLI</a> to stage input and output data for tasks.  The AWS CLI can either be installed in the task container or on the host instance that task containers run on.</p>
<p>Adding the AWS CLI to an existing containerized tool requires rebuilding the image to include it.  Assuming your tool's container image is based on CentOS, this would require a Dockerfile like so:</p>
<pre><code class="language-Dockerfile">FROM myoriginalcontainer
RUN yum install -y awscli

ENTRYPOINT [&quot;mytool&quot;]
</code></pre>
<p>If you have many tools in your pipeline, rebuilding all of their images and keeping them up to date may not be ideal.</p>
<p>Using a version installed on the host instance means you can use pre-existing containers.  To leveraage this, the AWS CLI must be self contained and not rely on system shared libraries. The <a href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html">AWS CLI v2</a> is packaged this way. The Launch Template deployed by the <a href="../../core-env/introduction.html">Core Environment</a> handles installing the AWS CLI v2 on instances launched by AWS Batch.</p>
<h3 id="batch-job-definition">Batch job definition</h3>
<p>An AWS Batch Job Definition to run a containerized Nextflow is shown below.</p>
<pre><code class="language-json">{
    &quot;jobDefinitionName&quot;: &quot;nextflow&quot;,
    &quot;jobDefinitionArn&quot;: &quot;arn:aws:batch:&lt;region&gt;:&lt;account-number&gt;:job-definition/nextflow:1&quot;,
    &quot;type&quot;: &quot;container&quot;,
    &quot;parameters&quot;: {},
    &quot;containerProperties&quot;: {
        &quot;image&quot;: &quot;&lt;account-number&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/nextflow:latest&quot;,
        &quot;vcpus&quot;: 2,
        &quot;memory&quot;: 1024,
        &quot;command&quot;: [],
        &quot;jobRoleArn&quot;: &quot;&lt;nextflowJobRoleArn&gt;&quot;,
        &quot;volumes&quot;: [],
        &quot;environment&quot;: [
            {
                &quot;name&quot;: &quot;NF_LOGSDIR&quot;,
                &quot;value&quot;: &quot;s3://&lt;bucket&gt;/_nextflow/logs&quot;
            },
            {
                &quot;name&quot;: &quot;NF_JOB_QUEUE&quot;,
                &quot;value&quot;: &quot;&lt;jobQueueArn&gt;&quot;
            },
            {
                &quot;name&quot;: &quot;NF_WORKDIR&quot;,
                &quot;value&quot;: &quot;s3://&lt;bucket&gt;/_nextflow/runs&quot;
            }
        ],
        &quot;mountPoints&quot;: [],
        &quot;ulimits&quot;: [],
        &quot;resourceRequirements&quot;: []
    }
}
</code></pre>
<p>The <code>&lt;nextflowJobRoleArn&gt;</code> is a reference to the IAM Role required by Nextflow head jobs and is described below.</p>
<h3 id="nextflow-iam-role">Nextflow IAM Role</h3>
<p>Nextflow needs to be able to create Batch Job Defintions, submit and cancel Batch Jobs, and read workflow logs and session information from S3. These permissions are provided via a Job Role associated with the Job Definition.  Policies for this role would look like the following:</p>
<h4 id="nextflow-batch-access">Nextflow-Batch-Access</h4>
<p>This policy gives <strong>full</strong> access to AWS Batch.</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;batch:*&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;
        }
    ]
}
</code></pre>
<h4 id="nextflow-s3bucket-access">Nextflow-S3Bucket-Access</h4>
<p>This policy gives <strong>full</strong> access to the buckets used to store workflow data and Nextflow session metadata.</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Action&quot;: [
                &quot;s3:*&quot;
            ],
            &quot;Resource&quot;: [
                &quot;arn:aws:s3:::&lt;nextflow-bucket-name&gt;&quot;,
                &quot;arn:aws:s3:::&lt;nextflow-bucket-name&gt;/*&quot;,
                &quot;arn:aws:s3:::&lt;data-bucket-name&gt;&quot;,
                &quot;arn:aws:s3:::&lt;data-bucket-name&gt;/*&quot;
            ],
            &quot;Effect&quot;: &quot;Allow&quot;
        }
    ]
}
</code></pre>
<h3 id="nextflow-specific-s3-bucket">Nextflow specific S3 Bucket</h3>
<p>Because running as a container will be an ephemeral process, the containerized version of <code>nextflow</code> stores workflow session information in S3 using paths described by <code>NF_WORKDIR</code> and <code>NF_LOGSDIR</code> environment variables.  These allow you to use Nextflow's <code>-resume</code> flag to restart a workflow that was previously interrupted at the step it left off at.</p>
<p>This bucket can be independent of the S3 bucket used to store workflow input and output data if necessary.</p>
<h2 id="workflow-process-definitions">Workflow process definitions</h2>
<p>The <code>process</code> definitions in Nextflow scripts should include a couple key parts for running on AWS Batch:</p>
<ul>
<li>the <code>container</code> directive</li>
<li><code>cpus</code> and <code>memory</code> directives to define resource that will be used by Batch Jobs</li>
</ul>
<p>!!! Note: The container image used to run a process needs to be capable of running the AWS CLI. It <strong>doesn't</strong> have to 
contain the CLI but it does need shared libraries from <code>glib.c</code> such as <code>libz.so.1</code> which may not be present in very 
minimal images.</p>
<p>An example definition for a simple "Hello World" process is shown below:</p>
<pre><code class="language-groovy">texts = Channel.from(&quot;AWS&quot;, &quot;Nextflow&quot;)

process hello {
    // directives
    // a container images is required
    container &quot;ubuntu:latest&quot;

    // compute resources for the Batch Job
    cpus 1
    memory '512 MB'

    input:
    val text from texts

    output:
    file 'hello.txt'

    &quot;&quot;&quot;
    echo &quot;Hello $text&quot; &gt; hello.txt
    &quot;&quot;&quot;
}
</code></pre>
<p>For each process in your workflow, Nextflow will create a corresponding Batch Job Definition, which it will re-use for subsequent workflow runs.  The process defined above will create a Batch Job Definition called <code>nf-ubuntu-latest</code> that looks like:</p>
<pre><code class="language-json">{
    &quot;jobDefinitionName&quot;: &quot;nf-ubuntu-latest&quot;,
    &quot;jobDefinitionArn&quot;: &quot;arn:aws:batch:&lt;region&gt;:&lt;account-number&gt;:job-definition/nf-ubuntu-latest:1&quot;,
    &quot;revision&quot;: 1,
    &quot;status&quot;: &quot;ACTIVE&quot;,
    &quot;type&quot;: &quot;container&quot;,
    &quot;parameters&quot;: {
        &quot;nf-token&quot;: &quot;43869867b5fbae16fa7cfeb5ea2c3522&quot;
    },
    &quot;containerProperties&quot;: {
        &quot;image&quot;: &quot;ubuntu:latest&quot;,
        &quot;vcpus&quot;: 1,
        &quot;memory&quot;: 1024,
        &quot;command&quot;: [
            &quot;true&quot;
        ],
        &quot;volumes&quot;: [
            {
                &quot;host&quot;: {
                    &quot;sourcePath&quot;: &quot;/opt/aws-cli&quot;
                },
                &quot;name&quot;: &quot;aws-cli&quot;
            }
        ],
        &quot;environment&quot;: [],
        &quot;mountPoints&quot;: [
            {
                &quot;containerPath&quot;: &quot;/opt/aws-cli&quot;,
                &quot;readOnly&quot;: true,
                &quot;sourceVolume&quot;: &quot;aws-cli&quot;
            }
        ],
        &quot;ulimits&quot;: []
    }
}
</code></pre>
<p>You can also use the <code>aws.batch.volumes</code> config option to define additional volumes and mount points so that your processes can have access to directories on the host instance.</p>
<h2 id="running-workflows">Running workflows</h2>
<p>To run a workflow you submit a <code>nextflow</code> Batch job to the appropriate Batch Job Queue via:</p>
<ul>
<li>the AWS Batch Console</li>
<li>the command line with the AWS CLI</li>
</ul>
<p>This is what starting a workflow via the AWS CLI would look like using a modified fork of Nextflow's built-in "hello-world" workflow:</p>
<pre><code class="language-bash">aws batch submit-job \
    --job-name nf-hello \
    --job-queue &lt;queue-name&gt; \
    --job-definition nextflow-&lt;nextflow-stack-namespace&gt; \
    --container-overrides command=wleepang/hello
</code></pre>
<p>!!! Note: The reason for the modification was purely to make use of a container that could provide libraries (such as <code>libz.so.1</code>) needed to run the AWS CLI which is responsible for marshalling files to and from S3
After submitting a workflow, you can monitor the progress of tasks via the AWS Batch console.
For the "Hello World" workflow above you will see five jobs run in Batch - one for the head node, and one for each <code>Channel</code> text as it goes through the <code>hello</code> process.</p>
<p>For a more complex example, you can try the following, which will run a demo <a href="https://github.com/nextflow-io/rnaseq-nf">RNASeq workflow</a> against data in the <a href="https://registry.opendata.aws/1000-genomes/">1000 Genomes AWS Public Dataset</a>:</p>
<pre><code class="language-bash">aws batch submit-job \
    --job-name nf-core-rnaseq \
    --job-queue &lt;queue-name&gt; \
    --job-definition nextflow-&lt;nextflow-stack-namespace&gt; \
    --container-overrides command=rnaseq-nf,\
&quot;--reads&quot;,&quot;'s3://1000genomes/phase3/data/HG00243/sequence_read/SRR*_{1,2}.filt.fastq.gz'&quot;,\
&quot;--genome&quot;,&quot;GRCh37&quot;,\
&quot;--skip_qc&quot;
</code></pre>
<p>For the example "rnaseq" workflow you will see 5 jobs run in Batch over the course of a couple hours - the head node will last the whole duration of the pipeline while the others will stop once their step is complete. You can look at the CloudWatch logs for the head node job to monitor workflow progress. Note the additional single quotes wrapping the 1000genomes path.</p>
<p>In both of the examples above, submitting workflows is an asynchronous task allowing you to quickly move on to other tasks. Importantly, AWS Batch handled scaling up all the compute needed to run workflow jobs, and when the workflow was complete, AWS Batch scaled all compute resources back down.</p>
<h2 id="cost-optimizing-workflows">Cost optimizing workflows</h2>
<p><a href="../cost-effective-workflows/cost-effective-workflows.html">Optimizing</a> the allocation of resources to your workflows can help you to reduce costs</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../cromwell/cromwell-trouble-shooting.html" title="Trouble Shooting" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Trouble Shooting
              </span>
            </div>
          </a>
        
        
          <a href="nextflow-trouble-shooting.html" title="Trouble Shooting" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Trouble Shooting
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            2019 Amazon Web Services
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.9e1f3b71.js"></script>
      
      <script>app.initialize({version:"1.3.0",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>