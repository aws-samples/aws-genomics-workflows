



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-3.1.0">
    
    
      
        <title>Overview - Genomics Workflows on AWS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.11e41852.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#546e7a">
      
    
    
      <script src="../../assets/javascripts/modernizr.20ef595d.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue-grey" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#aws-step-functions-for-genomics-workflows" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../index.html" title="Genomics Workflows on AWS" class="md-header-nav__button md-logo">
          
            <img src="../../images/AWS_logo_RGB_REV.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Genomics Workflows on AWS
              </span>
              <span class="md-header-nav__topic">
                Overview
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/aws-samples/aws-genomics-workflows/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Contribute
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../index.html" title="Genomics Workflows on AWS" class="md-nav__button md-logo">
      
        <img src="../../images/AWS_logo_RGB_REV.svg" width="48" height="48">
      
    </a>
    Genomics Workflows on AWS
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/aws-samples/aws-genomics-workflows/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Contribute
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../index.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../disclaimer.html" title="Disclaimer" class="md-nav__link">
      Disclaimer
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../quick-start.html" title="Quick Start" class="md-nav__link">
      Quick Start
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Core Environment
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Core Environment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/introduction.html" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/create-s3-bucket.html" title="Data Storage" class="md-nav__link">
      Data Storage
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/create-iam-roles.html" title="Permissions" class="md-nav__link">
      Permissions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/create-custom-compute-resources.html" title="Compute Resources" class="md-nav__link">
      Compute Resources
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/setup-aws-batch.html" title="AWS Batch" class="md-nav__link">
      AWS Batch
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/custom-deploy.html" title="Customized Deployment" class="md-nav__link">
      Customized Deployment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../core-env/build-custom-distribution.html" title="Building a Custom Distribution" class="md-nav__link">
      Building a Custom Distribution
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Workflow Orchestration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Workflow Orchestration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../orchestration-intro.html" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-2" type="checkbox" id="nav-5-2" checked>
    
    <label class="md-nav__link" for="nav-5-2">
      AWS Step Functions
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-2">
        AWS Step Functions
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Overview
      </label>
    
    <a href="step-functions-overview.html" title="Overview" class="md-nav__link md-nav__link--active">
      Overview
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" title="Requirements" class="md-nav__link">
    Requirements
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc" title="VPC" class="md-nav__link">
    VPC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genomics-workflow-core" title="Genomics Workflow Core" class="md-nav__link">
    Genomics Workflow Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-functions-resources" title="Step Functions Resources" class="md-nav__link">
    Step Functions Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-details" title="Deployment Details" class="md-nav__link">
    Deployment Details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-step-functions-execution-role" title="AWS Step Functions Execution Role" class="md-nav__link">
    AWS Step Functions Execution Role
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-functions-state-machines" title="Step Functions State Machines" class="md-nav__link">
    Step Functions State Machines
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-workflows-with-aws-step-functions" title="Building workflows with AWS Step Functions" class="md-nav__link">
    Building workflows with AWS Step Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-job-definitions" title="Batch Job Definitions" class="md-nav__link">
    Batch Job Definitions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-machine-batch-job-tasks" title="State Machine Batch Job Tasks" class="md-nav__link">
    State Machine Batch Job Tasks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-state-machine" title="Example state machine" class="md-nav__link">
    Example state machine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-workflow" title="Running the workflow" class="md-nav__link">
    Running the workflow
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-optimizing-workflows" title="Cost optimizing workflows" class="md-nav__link">
    Cost optimizing workflows
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Cromwell
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Cromwell
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cromwell/cromwell-overview.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cromwell/cromwell-examples.html" title="Examples" class="md-nav__link">
      Examples
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cromwell/cromwell-trouble-shooting.html" title="Trouble Shooting" class="md-nav__link">
      Trouble Shooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Nextflow
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Nextflow
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../nextflow/nextflow-overview.html" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nextflow/nextflow-trouble-shooting.html" title="Trouble Shooting" class="md-nav__link">
      Trouble Shooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../cost-effective-workflows/cost-effective-workflows.html" title="Cost Effective Workflows" class="md-nav__link">
      Cost Effective Workflows
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#requirements" title="Requirements" class="md-nav__link">
    Requirements
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vpc" title="VPC" class="md-nav__link">
    VPC
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#genomics-workflow-core" title="Genomics Workflow Core" class="md-nav__link">
    Genomics Workflow Core
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-functions-resources" title="Step Functions Resources" class="md-nav__link">
    Step Functions Resources
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deployment-details" title="Deployment Details" class="md-nav__link">
    Deployment Details
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws-step-functions-execution-role" title="AWS Step Functions Execution Role" class="md-nav__link">
    AWS Step Functions Execution Role
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-functions-state-machines" title="Step Functions State Machines" class="md-nav__link">
    Step Functions State Machines
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-workflows-with-aws-step-functions" title="Building workflows with AWS Step Functions" class="md-nav__link">
    Building workflows with AWS Step Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#batch-job-definitions" title="Batch Job Definitions" class="md-nav__link">
    Batch Job Definitions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-machine-batch-job-tasks" title="State Machine Batch Job Tasks" class="md-nav__link">
    State Machine Batch Job Tasks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-state-machine" title="Example state machine" class="md-nav__link">
    Example state machine
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-workflow" title="Running the workflow" class="md-nav__link">
    Running the workflow
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cost-optimizing-workflows" title="Cost optimizing workflows" class="md-nav__link">
    Cost optimizing workflows
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/aws-genomics-workflows/edit/master/docs/orchestration/step-functions/step-functions-overview.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="aws-step-functions-for-genomics-workflows">AWS Step Functions For Genomics Workflows</h1>
<p><img alt="AWS reference architecture for genomics" src="images/aws-sfn-genomics-workflow-arch.png" /></p>
<p>The <a href="https://aws.amazon.com/step-functions/">AWS Step Functions</a> service allows you to orchestrate other AWS services, such as Lambda, Batch, SNS, and Glue, making it easy to coordinate the components of distributed applications as a series of steps in a visual workflow.</p>
<p>In the context of genomics workflows, the combination of AWS Step Functions with Batch and Lambda constitutes a robust, scalable, and serverless task orchestration solution.</p>
<h2 id="requirements">Requirements</h2>
<p>To get started using AWS Step Functions for genomics workflows you'll need the following setup in your AWS account:</p>
<ul>
<li>A VPC with at least 2 subnets (preferrably ones that are <strong>private</strong>)</li>
<li>The Genomics Workflow <a href="../../core-env/introduction.html">Core Environment</a></li>
<li>Containerized tools for your workflow steps like BWA-MEM, Samtools, BCFtools custom entrypoint scripts that uses AWS Batch supplied environment variables for configuration and data handling</li>
<li>A Batch Job Definitions for your tools</li>
<li>An IAM Role for AWS Step Functions that allows it to submit AWS Batch jobs</li>
</ul>
<p>The following will help you deploy these components</p>
<h3 id="vpc">VPC</h3>
<p>If you are handling sensitive data in your genomics pipelines, we recommend using at least 2 <strong>private</strong> subnets for AWS Batch compute jobs. EC2 instances launched into <strong>private</strong> subnets do not have public IP addresses, and therefore cannot be directly accessed from the public internet. They can still retain internet access from within the VPC - e.g. to pull source code, retrive public datasets, or install required softwre - if networking is configured appropriately. If the target VPC you want to deploy into already has this, you can skip ahead. If not, you can use the CloudFormation template below, which uses the <a href="https://aws.amazon.com/quickstart/architecture/vpc/">AWS VPC Quickstart</a>, to create one meeting these requirements.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th style="text-align: center;">Source</th>
<th style="text-align: center;">Launch Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td>VPC (Optional)</td>
<td>Creates a new Virtual Private Cloud to use for your genomics workflow resources.</td>
<td style="text-align: center;"><a href="https://aws-quickstart.s3.amazonaws.com/quickstart-aws-vpc/templates/aws-vpc.template.yaml" target="_blank"><i class="material-icons">cloud_download</i></a></td>
<td style="text-align: center;"><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=GenomicsVPC&templateURL=https://aws-quickstart.s3.amazonaws.com/quickstart-aws-vpc/templates/aws-vpc.template.yaml" target="_blank" class="launch-button"><i class="material-icons">play_arrow</i></a></td>
</tr>
</tbody>
</table>
<h3 id="genomics-workflow-core">Genomics Workflow Core</h3>
<p>To launch the Genomics Workflow Core in your AWS account, use the CloudFormation template below.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th style="text-align: center;">Source</th>
<th style="text-align: center;">Launch Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td>Genomics Workflow Core</td>
<td>Create EC2 Launch Templates, AWS Batch Job Queues and Compute Environments, a secure Amazon S3 bucket, and IAM policies and roles within an <strong>existing</strong> VPC. <em>NOTE: You must provide VPC ID, and subnet IDs</em>.</td>
<td style="text-align: center;"><a href="https://github.com/aws-samples/aws-genomics-workflows/blob/master/src/templates/gwfcore/gwfcore-root.template.yaml" target="_blank"><i class="material-icons">cloud_download</i></a></td>
<td style="text-align: center;"><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=gwfcore&templateURL=https://aws-genomics-workflows.s3.amazonaws.com/latest/templates/gwfcore/gwfcore-root.template.yaml" target="_blank" class="launch-button"><i class="material-icons">play_arrow</i></a></td>
</tr>
</tbody>
</table>
<p>The core is agnostic of the workflow orchestrator you intended to use, and can be installed multiple times in your account if needed (e.g. for use by different projects). Each installation uses a <code>Namespace</code> value to group resources accordingly. By default, the <code>Namespace</code> is set to the stack name, which must be unique within an AWS region.</p>
<p>See the <a href="../../core-env/introduction.html">Core Environment</a> For more details on the core's architecture.</p>
<h3 id="step-functions-resources">Step Functions Resources</h3>
<p>The the following CloudFormation template will create an AWS Step Functions State Machine that defines an example variant calling workflow using BWA-MEM, Samtools, and BCFtools; container images and AWS Batch Job Definitions for the tooling; and an IAM Role that allows AWS Step Functions to call AWS Batch during State Machine executions:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
<th style="text-align: center;">Source</th>
<th>Launch Stack</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWS Step Functions Resources</td>
<td>Create a Step Functions State Machine, Batch Job Definitions, and container images to run an example genomics workflow</td>
<td style="text-align: center;"><a href="https://github.com/aws-samples/aws-genomics-workflows/blob/master/src/templates/step-functions/sfn-resources.template.yaml" target="_blank"><i class="material-icons">cloud_download</i></a></td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?#/stacks/new?stackName=sfn-resources&templateURL=https://aws-genomics-workflows.s3.amazonaws.com/latest/templates/step-functions/sfn-resources.template.yaml" target="_blank" class="launch-button"><i class="material-icons">play_arrow</i></a></td>
</tr>
</tbody>
</table>
<h2 id="deployment-details">Deployment Details</h2>
<h3 id="aws-step-functions-execution-role">AWS Step Functions Execution Role</h3>
<p>An AWS Step Functions Execution role is an IAM role that allows Step Functions to execute other AWS services via the state machine.</p>
<p>This can be created automatically during the "first-run" experience in the AWS Step Functions console when you create your first state machine.  The policy attached to the role will depend on the specifc tasks you incorporate into your state machine.</p>
<p>State machines that use AWS Batch for job execution and send events to CloudWatch should have an Execution role with the following inline policy:</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;enable submitting batch jobs&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;batch:SubmitJob&quot;,
                &quot;batch:DescribeJobs&quot;,
                &quot;batch:TerminateJob&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;
        },
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;events:PutTargets&quot;,
                &quot;events:PutRule&quot;,
                &quot;events:DescribeRule&quot;
            ],
            &quot;Resource&quot;: [
                &quot;arn:aws:events:&lt;region&gt;:&lt;account-number&gt;:rule/StepFunctionsGetEventsForBatchJobsRule&quot;
            ]
        }
    ]
}
</code></pre>
<p>For more complex workflows that use nested workflows or require more complex input parsing, you need to add additional permissions for executing Step Functions State Machines and invoking Lambda functions:</p>
<pre><code class="language-json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Sid&quot;: &quot;enable calling lambda functions&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;lambda:InvokeFunction&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;
        },
        {
            &quot;Sid&quot;: &quot;enable calling other step functions&quot;,
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;states:StartExecution&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;
        },
        ...
    ]
}
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All <code>Resource</code> values in the policy statements above can be scoped to be more specific if needed.</p>
</div>
<h3 id="step-functions-state-machines">Step Functions State Machines</h3>
<p>Workflows in AWS Step Functions are built using <a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html">Amazon States Language</a> (ASL), a declarative, JSON-based, structured language used to define a "state-machine".  An AWS Step Functions State-Machine is a collection of states that can do work (Task states), determine which states to transition to next (Choice states), stop an execution with an error (Fail states), and so on.</p>
<h4 id="building-workflows-with-aws-step-functions">Building workflows with AWS Step Functions</h4>
<p>The overall structure of a state-machine looks like the following:</p>
<pre><code class="language-json">{
  &quot;Comment&quot;: &quot;Description of you state-machine&quot;,
  &quot;StartAt&quot;: &quot;FirstState&quot;,
  &quot;States&quot;: {
    &quot;FirstState&quot;: {
        &quot;Type&quot;: &quot;&lt;state-type&gt;&quot;,
        &quot;Next&quot;: &quot;&lt;name of next state&gt;&quot;
    },

    &quot;State1&quot; : {
        ...
    },
    ...

    &quot;StateN&quot; : {
        ...
    },

    &quot;LastState&quot;: {
        ...
        &quot;End&quot;: true
    }
  }
}
</code></pre>
<p>A simple "Hello World" state-machine looks like this:</p>
<pre><code class="language-json">{
  &quot;Comment&quot;: &quot;A Hello World example of the Amazon States Language using a Pass state&quot;,
  &quot;StartAt&quot;: &quot;HelloWorld&quot;,
  &quot;States&quot;: {
    &quot;HelloWorld&quot;: {
      &quot;Type&quot;: &quot;Pass&quot;,
      &quot;Result&quot;: &quot;Hello World!&quot;,
      &quot;End&quot;: true
  }
}
</code></pre>
<p>ASL supports several task types and simple structures that can be combined to form a wide variety of complex workflows.</p>
<p><img alt="ASL Structures" src="images/step-functions-structures.png" /></p>
<p>More detailed coverage of ASL state types and structures is provided in the 
Step Functions <a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html">ASL documentation</a>.</p>
<h4 id="batch-job-definitions">Batch Job Definitions</h4>
<p><a href="https://docs.aws.amazon.com/batch/latest/userguide/job_definitions.html">AWS Batch Job Definitions</a> are used to define compute resource requirements and parameter defaults for an AWS Batch Job.  These are then referenced in state machine <code>Task</code> states by their respective ARNs.</p>
<p>An example Job Definition for the <code>bwa-mem</code> sequence aligner is shown below:</p>
<pre><code class="language-json">{
    &quot;jobDefinitionName&quot;: &quot;bwa-mem&quot;,
    &quot;type&quot;: &quot;container&quot;,
    &quot;parameters&quot;: {
        &quot;threads&quot;: &quot;8&quot;
    },
    &quot;containerProperties&quot;: {
        &quot;image&quot;: &quot;&lt;dockerhub-user&gt;/bwa-mem:latest&quot;,
        &quot;vcpus&quot;: 8,
        &quot;memory&quot;: 32000,
        &quot;command&quot;: [
            &quot;bwa&quot;, &quot;mem&quot;,
            &quot;-t&quot;, &quot;Ref::threads&quot;,
            &quot;-p&quot;,
            &quot;reference.fasta&quot;,
            &quot;sample_1.fastq.gz&quot;
        ],
        &quot;volumes&quot;: [
            {
                &quot;host&quot;: {
                    &quot;sourcePath&quot;: &quot;/scratch&quot;
                },
                &quot;name&quot;: &quot;scratch&quot;
            },
            {
                &quot;host&quot;: {
                    &quot;sourcePath&quot;: &quot;/opt/miniconda&quot;
                },
                &quot;name&quot;: &quot;aws-cli&quot;
            }
        ],
        &quot;environment&quot;: [
            {
                &quot;name&quot;: &quot;REFERENCE_URI&quot;,
                &quot;value&quot;: &quot;s3://&lt;bucket-name&gt;/reference/*&quot;
            },
            {
                &quot;name&quot;: &quot;INPUT_DATA_URI&quot;,
                &quot;value&quot;: &quot;s3://&lt;bucket-name&gt;/&lt;sample-name&gt;/fastq/*.fastq.gz&quot;
            },
            {
                &quot;name&quot;: &quot;OUTPUT_DATA_URI&quot;,
                &quot;value&quot;: &quot;s3://&lt;bucket-name&gt;/&lt;sample-name&gt;/aligned&quot;
            }
        ],
        &quot;mountPoints&quot;: [
            {
                &quot;containerPath&quot;: &quot;/opt/work&quot;,
                &quot;sourceVolume&quot;: &quot;scratch&quot;
            },
            {
                &quot;containerPath&quot;: &quot;/opt/miniconda&quot;,
                &quot;sourceVolume&quot;: &quot;aws-cli&quot;
            }
        ],
        &quot;ulimits&quot;: []
    }
}
</code></pre>
<p>There are three key parts of the above definition to take note of.</p>
<ul>
<li>
<p>Command and Parameters</p>
<p>The <strong>command</strong> is a list of strings that will be sent to the container.  This is the same as the <code>...</code> arguments that you would provide to a <code>docker run mycontainer ...</code> command.</p>
<p><strong>Parameters</strong> are placeholders that you define whose values are substituted when a job is submitted.  In the case above a <code>threads</code> parameter is defined with a default value of <code>8</code>.  The job definition's <code>command</code> references this parameter with <code>Ref::threads</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Parameter references in the command list must be separate strings - concatenation with other parameter references or static values is not allowed.</p>
</div>
</li>
<li>
<p>Environment</p>
<p><strong>Environment</strong> defines a set of environment variables that will be available for the container. For example, you can define environment variables used by the container entrypoint script to identify data it needs to stage in.</p>
</li>
<li>
<p>Volumes and Mount Points</p>
<p>Together, <strong>volumes</strong> and <strong>mountPoints</strong> define what you would provide as using a <code>-v hostpath:containerpath</code> option to a <code>docker run</code> command.  These can be used to map host directories with resources (e.g. data or tools) used by all containers.  In the example above, a <code>scratch</code> volume is mapped so that the container can utilize a larger disk on the host.  Also, a version of the AWS CLI installed with <code>conda</code> is mapped into the container - enabling the container to have access to it (e.g. so it can transfer data from S3 and back) with out explicitly building in.</p>
</li>
</ul>
<h4 id="state-machine-batch-job-tasks">State Machine Batch Job Tasks</h4>
<p>AWS Step Functions has built-in integration with AWS Batch (and <a href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-connectors.html">several other services</a>), and provides snippets of code to make developing your state-machine tasks easier.</p>
<p><img alt="Manage a Batch Job Snippet" src="images/sfn-batch-job-snippet.png" /></p>
<p>The corresponding state machine state for the <code>bwa-mem</code> Job definition above
would look like the following:</p>
<pre><code class="language-json">&quot;BwaMemTask&quot;: {
    &quot;Type&quot;: &quot;Task&quot;,
    &quot;InputPath&quot;: &quot;$&quot;,
    &quot;ResultPath&quot;: &quot;$.bwa-mem.status&quot;,
    &quot;Resource&quot;: &quot;arn:aws:states:::batch:submitJob.sync&quot;,
    &quot;Parameters&quot;: {
        &quot;JobDefinition&quot;: &quot;arn:aws:batch:&lt;region&gt;:&lt;account&gt;:job-definition/bwa-mem:1&quot;,
        &quot;JobName&quot;: &quot;bwa-mem&quot;,
        &quot;JobQueue&quot;: &quot;&lt;queue-arn&gt;&quot;,
        &quot;Parameters.$&quot;: &quot;$.bwa-mem.parameters&quot;,
        &quot;Environment&quot;: [
            {&quot;Name&quot;: &quot;REFERENCE_URI&quot;,
             &quot;Value.$&quot;: &quot;$.bwa-mem.environment.REFERENCE_URI&quot;},
            {&quot;Name&quot;: &quot;INPUT_DATA_URI&quot;,
             &quot;Value.$&quot;: &quot;$.bwa-mem.environment.INPUT_DATA_URI&quot;},
            {&quot;Name&quot;: &quot;OUTPUT_DATA_URI&quot;,
             &quot;Value.$&quot;: &quot;$.bwa-mem.environment.OUTPUT_DATA_URI&quot;}
        ]
    },
    &quot;Next&quot;: &quot;NEXT_TASK_NAME&quot;
}
</code></pre>
<p>Inputs to a state machine that uses the above <code>BwaMemTask</code> would look like this:</p>
<pre><code class="language-json">{
    &quot;bwa-mem&quot;: {
        &quot;parameters&quot;: {
            &quot;threads&quot;: 8
        },
        &quot;environment&quot;: {
            &quot;REFERENCE_URI&quot;: &quot;s3://&lt;bucket-name/&gt;&lt;sample-name&gt;/reference/*&quot;,
            &quot;INPUT_DATA_URI&quot;: &quot;s3://&lt;bucket-name/&gt;&lt;sample-name&gt;/fastq/*.fastq.gz&quot;,
            &quot;OUTPUT_DATA_URI&quot;: &quot;s3://&lt;bucket-name/&gt;&lt;sample-name&gt;/aligned&quot;
        }
    },
    ...
}
</code></pre>
<p>When the Task state completes Step Functions will add information to a new <code>status</code> key under <code>bwa-mem</code> in the JSON object.  The complete object will be passed on to the next state in the workflow.</p>
<h3 id="example-state-machine">Example state machine</h3>
<p>The example workflow is a simple secondary analysis pipeline that converts raw FASTQ files into VCFs with variants called for a list of chromosomes.  It uses the following open source based tools:</p>
<ul>
<li><code>bwa-mem</code>: Burrows-Wheeler Aligner for aligning short sequence reads to a reference genome</li>
<li><code>samtools</code>: <strong>S</strong>equence <strong>A</strong>lignment <strong>M</strong>apping library for indexing and sorting aligned reads</li>
<li><code>bcftools</code>: <strong>B</strong>inary (V)ariant <strong>C</strong>all <strong>F</strong>ormat library for determining variants in sample reads relative to a reference genome</li>
</ul>
<p>Read alignment, sorting, and indexing occur sequentially by Step Functions Task States.  Variant calls for chromosomes occur in parallel using a Step Functions Map State and sub-Task States therein.  All tasks submit AWS Batch Jobs to perform computational work using containerized versions of the tools listed above.</p>
<p><img alt="example genomics workflow state machine" src="images/sfn-example-mapping-state-machine.png" /></p>
<p>The tooling containers used by the workflow use a <a href="https://github.com/aws-samples/aws-genomics-workflows/tree/master/src/containers">generic entrypoint script</a> that wraps the underlying tool and handles S3 data staging.  It uses the AWS CLI to transfer objects and environment variables to identify data inputs and outputs to stage.</p>
<h3 id="running-the-workflow">Running the workflow</h3>
<p>When the stack above completes, go to the outputs tab and copy the JSON string provided in <code>StateMachineInput</code>.</p>
<p><img alt="cloud formation output tab" src="images/cfn-stack-outputs-tab.png" />
<img alt="example state-machine input" src="images/cfn-stack-outputs-statemachineinput.png" /></p>
<p>The input JSON will look like the following, but with the values for <code>queue</code> and <code>JOB_OUTPUT_PREFIX</code> prepopulated with resource names specific to the stack created by the CloudFormation template above:</p>
<pre><code class="language-json">{
    &quot;params&quot;: {
        &quot;__comment__&quot;: {
            &quot;replace values for `queue` and `environment.JOB_OUTPUT_PREFIX` with values that match your resources&quot;: {
                &quot;queue&quot;: &quot;Name or ARN of the AWS Batch Job Queue the workflow will use by default.&quot;,
                &quot;environment.JOB_OUTPUT_PREFIX&quot;: &quot;S3 URI (e.g. s3://bucket/prefix) you are using for workflow inputs and outputs.&quot;
            },
        },
        &quot;queue&quot;: &quot;default&quot;,
        &quot;environment&quot;: {
            &quot;REFERENCE_NAME&quot;: &quot;Homo_sapiens_assembly38&quot;,
            &quot;SAMPLE_ID&quot;: &quot;NIST7035&quot;,
            &quot;SOURCE_DATA_PREFIX&quot;: &quot;s3://aws-batch-genomics-shared/secondary-analysis/example-files/fastq&quot;,
            &quot;JOB_OUTPUT_PREFIX&quot;: &quot;s3://YOUR-BUCKET-NAME/PREFIX&quot;,
            &quot;JOB_AWS_CLI_PATH&quot;: &quot;/opt/miniconda/bin&quot;
        },
        &quot;chromosomes&quot;: [
            &quot;chr19&quot;,
            &quot;chr20&quot;,
            &quot;chr21&quot;,
            &quot;chr22&quot;
        ]
    }
}
</code></pre>
<p>Next head to the AWS Step Functions console and select the state-machine that was created.</p>
<p><img alt="select state-machine" src="images/sfn-console-statemachine.png" /></p>
<p>Click the "Start Execution" button.</p>
<p><img alt="start execution" src="images/sfn-console-start-execution.png" /></p>
<p>In the dialog that appears, paste the input JSON into the "Input" field, and click the "Start Execution" button.  (A unique execution ID will be automatically generated).</p>
<p><img alt="start execution dialog" src="images/sfn-console-start-execution-dialog.png" /></p>
<p>You will be taken to the execution tracking page where you can monitor the progress of your workflow.</p>
<p><img alt="execution tracking" src="images/sfn-console-execution-inprogress.png" /></p>
<p>The example workflow references a small demo dataset and takes approximately 20-30 minutes to complete.</p>
<h2 id="cost-optimizing-workflows">Cost optimizing workflows</h2>
<p><a href="../cost-effective-workflows/cost-effective-workflows.html">Optimizing</a> the allocation of resources to your workflows can help you to reduce costs</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../orchestration-intro.html" title="Introduction" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Introduction
              </span>
            </div>
          </a>
        
        
          <a href="../cromwell/cromwell-overview.html" title="Overview" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Overview
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            2019 Amazon Web Services
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.9e1f3b71.js"></script>
      
      <script>app.initialize({version:"1.3.0",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>